name: PR Preview
on:
  pull_request:
    types: [opened, reopened, synchronize, closed]

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  FLY_REGION: lhr
  PNPM_VERSION: 10.4.1

jobs:
  deploy_pr_apps:
    runs-on: ubuntu-latest

    # Only run one deployment at a time per PR
    concurrency:
      group: pr-${{ github.event.number }}
      cancel-in-progress: true

    environment:
      name: pr-${{ github.event.number }}
      url: ${{ steps.deploy-frontend.outputs.url }}

    steps:
      - uses: actions/checkout@v4

      - name: Deploy API
        id: deploy-api
        uses: superfly/fly-pr-review-apps@1.5.0
        with:
          name: pr-${{ github.event.number }}-framer-api
          config: fly.staging.api.toml
          build_args: >-
            BUILD_PROFILE=staging
            INSTALL_EXTRA_CERTS=true
            RUST_LOG_LEVEL=info

      - name: Deploy Frontend
        id: deploy-frontend
        uses: superfly/fly-pr-review-apps@1.5.0
        with:
          name: pr-${{ github.event.number }}-framer-frontend
          config: fly.staging.frontend.toml
          build_args: >-
            NEXT_PUBLIC_API_URL=https://pr-${{ github.event.number }}-framer-api.fly.dev
            NEXT_PUBLIC_APP_URL=https://pr-${{ github.event.number }}-framer-frontend.fly.dev
            NEXT_PUBLIC_APP_ENV=preview

      - name: Clean up GitHub environment
        uses: strumwolf/delete-deployment-environment@v2
        if: ${{ github.event.action == 'closed' }}
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: pr-${{ github.event.number }}
